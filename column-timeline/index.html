<!DOCTYPE html>
<html>
<head>
    <title>Column chart - Visual Vocabulary</title>
    <script src="//d3js.org/d3.v4.js"></script>
    <script src="//d3js.org/d3-selection-multi.v1.min.js"></script>
    <script src="https://unpkg.com/g-chartframe"></script>
    <script src="//ft-interactive.github.io/visual-vocabulary/shared/svg2png.js"></script>
    <script src="https://unpkg.com/g-chartcolour"></script>
    <script src="main.js"></script>
    <script src="legend.js"></script>
    <!-- Uncomment which axes you need to include for your chart -->
    <script src="https://rawgit.com/ft-interactive/g-yaxislinear/master/build/g-yaxislinear.js"></script>
    <!-- <script src="https://rawgit.com/ft-interactive/g-yaxisOrdinal/master/build/g-yaxisOrdinal.js"></script> -->
    <script src="https://rawgit.com/ft-interactive/g-xaxisdate/master/build/g-xaxisdate.js"></script>
    <script src="xAxisOrdinal.js"></script>
    <!-- <script src="https://rawgit.com/ft-interactive/g-xaxisOrdinal/master/build/g-xaxisOrdinal.js"></script> -->
    <!-- <script src="https://rawgit.com/ft-interactive/g-xaxisLinear/master/build/g-xaxisLinear.js"></script> -->
    <link rel="stylesheet" href="styles.css"/>
    <link rel="stylesheet" href="https://www.ft.com/__origami/service/build/v2/bundles/css?modules=o-fonts@^2.2.0" />
    <style>
    .saveable button{ display: block; }
    </style>
</head>
<body>

    <h1>Column chart</h1>
    <p>A suggested starting point for creating cross-platform artisinal charts with default FT styling</p>
    <p><b>Some useful settings in the index.html</b>
        <ul>
            <li><b>yMin</b> and <b>yMax</b> – use these to set the lower and upper values of the y-axis</li>
            <li><b>numTicksy</b> – set the number of scale lines on the y-axis</li>
            <li><b>interval</b> – options available are "century","jubilee" (50 years), decade", "lustrum" (5 years), "years","months","days"</li>
        </ul>
    </p>
     <p><b>Column headings in the csv</b>
        <ul>
            <li><b>highlight</b> – use this column to define highlight bands in the background of your chart, add 'begin' where you want the band to start and 'end' where you want it to finish. You can have as many highlights as you want.</li>
        </ul>
    </p>
    <hr>
    <figure class="framed saveable" data-frame="webS"><svg></svg></figure>
    <figure class="framed saveable" data-frame="webM"><svg></svg></figure>
    <figure class="framed saveable" data-frame="webL"><svg></svg></figure>
    <figure class="framed saveable" data-frame="print"><svg></svg></figure>
    <figure class="framed saveable" data-frame="social"><svg></svg></figure>
    <figure class="framed saveable" data-frame="video"><svg></svg></figure>

</body>

<script type="text/javascript">

//User defined constants similar to version 2
const dateStructure = "%d-%b-%y";

const dataFile = "data.csv"

const sharedConfig = {
  title:"Title not yet added",
  subtitle:"Subtitle not yet added",  
  source:"Source not yet added",
}
let yMin = 0;//sets the minimum value on the yAxis
let yMax = 0;//sets the maximum value on the xAxis
const yAxisHighlight = -1; //sets which tick to highlight on the yAxis
const numTicksy = 5;//Number of tick on the uAxis
const yAxisAlign = "right";//alignment of the axis
const xAxisAlign = "bottom";//alignment of the axis
const interval = "years";//date interval on xAxis "century", "jubilee", "decade", "lustrum", "years","months","days"
let minorAxis = false;//turns on or off the minor axis
let legendAlign = "vert";//hori or vert, alignment of the legend
let legendType = 'rect';//rect, line or circ, geometry of legend marker

//Individual frame configuratiuon, used to set margins (defaults shown below) etc
const frame = {
   webS: gChartframe.webFrameS(sharedConfig)
   .margin({top:100, left:15, bottom:82, right:5})
   // .title("Put headline here") //use this if you need to override the defaults
   // .subtitle("Put headline |here") //use this if you need to override the defaults
   .height(400),

   webM: gChartframe.webFrameM(sharedConfig)
   .margin({top:100, left:20, bottom:86, right:5})
   // .title("Put headline here")
   .height(500),

   webL: gChartframe.webFrameL(sharedConfig)
   .margin({top:100, left:20, bottom:104, right:5})
   // .title("Put headline here")
   .height(700)
   .fullYear(true),

   print: gChartframe.printFrame(sharedConfig)
   .margin({top:40, left:7, bottom:35, right:7})
   // .title("Put headline here")
   .height(69.85)
   .width(55),

   social: gChartframe.socialFrame(sharedConfig)
   .margin({top:140, left:50, bottom:138, right:40})
   // .title("Put headline here")
   .height(750), // 700 is ideal height for Instagram

   video: gChartframe.videoFrame(sharedConfig)
   .margin({left:207, right:207, bottom:210, top:233})
   // .title("Put headline here")
};


//add the frames to the page...
d3.selectAll('.framed')
    .each(function(){
        const figure = d3.select(this);
        figure.select('svg')
            .call(frame[figure.node().dataset.frame]);
    });

d3.csv(dataFile, function(data) {
    //make sure all the dates in the date column are a date object
    var parseDate = d3.timeParse(dateStructure)
    data.forEach(function(d) {
                d.date=parseDate(d.date);
            });

    //automatically calculate the seriesnames excluding the "name" column
    const seriesNames = getSeriesNames(data.columns)
   
    //Use the seriesNames array to calculate the minimum and max values in the dataset
    const valueExtent = extentMulti(data,seriesNames)

    const columnNames = [ ...new Set(data.map(d=>d.date)) ]; // create an array of the column names

    //format the data that is used to draw highlight tonal bands
    const boundaries=data.filter((d)=> (d.highlight==="begin" || d.highlight==="end"))
    let highlights=[]
    boundaries.forEach(function(d,i){
        if (d.highlight==="begin") {
            highlights.push({begin: d.date,end:boundaries[i+1].date}) 
        }
    })

    //define chart
    const myChart = columnChart()
          .seriesNames(seriesNames)
          .yDomain([Math.min(yMin,valueExtent[0]),Math.max(yMax,valueExtent[1])])
          .xDomain0(d3.extent(data, function(d) {return d.date;}))
          .yAxisAlign(yAxisAlign)
    
    
    //format the dataset that is used to draw the lines
    let plotData=seriesNames.map(function(d,i){
        return {
            name:d,
            columnData:getColumns(data,d)
        }
    })


    console.log(plotData);

    Object.keys(frame).forEach(frameName=>{
        const currentFrame = frame[frameName];

        const myXAxis0 = gAxis.xaxisDate();//sets up yAxis
        const myXAxis1 = xAxisOrdinal();//sets up yAxis
        const myXAxis2 = xAxisOrdinal();//sets up yAxis
        const myYAxis = gAxis.yaxisLinear();
        const myLegend = drawLegend();
        const myHighlights = drawHighlights()//sets up highlight tonal bands

        //define other functions to be called
        const tickSize = currentFrame.dimension().width;//Used when drawing the yAxis ticks

        d3.select(currentFrame.plot().node().parentNode)
            .call(currentFrame);

        //create a 'g' element at the back of the chart to add time period highlights after axis have been created
        let axisHighlight = currentFrame.plot().append('g');

        myChart
            .yRange( [currentFrame.dimension().height,0] )
            .plotDim(currentFrame.dimension())
            .rem(currentFrame.rem())
            .colourPalette((frameName));

        myYAxis
            .yScale(myChart.yScale())
            .numTicks(numTicksy)
            .tickSize(tickSize)
            .yAxisHighlight(yAxisHighlight)
            .tickAlign(myChart.yAxisAlign())

        let base = currentFrame.plot().append("g")
        
        currentFrame.plot()
          .call(myYAxis);


         //return the value in the variable newMargin
        if (yAxisAlign=="right") {
            let newMargin = myYAxis.labelWidth()+currentFrame.margin().right
            //Use newMargin redefine the new margin and range of xAxis
            currentFrame.margin({right:newMargin});
        }
        else {
            let newMargin = myYAxis.labelWidth()+currentFrame.margin().left
            //Use newMargin re define the new margin and range of xAxis
            currentFrame.margin({left:newMargin});
        }


        myChart.xRange0( [0, currentFrame.dimension().width] );
        myChart.xRange1( [0, currentFrame.dimension().width] );
        myChart.xRange2( [0, currentFrame.dimension().width] );

        myXAxis0
            .fullYear(currentFrame.fullYear())
            .scale(myChart.xScale0())
            .offset(currentFrame.dimension().height)
            .interval(interval)
            .tickSize(myChart.rem())
            .minorAxis(minorAxis);
        
         //Set up highlights for this frame
        myHighlights
            .yScale(myChart.yScale())
            .yRange( [currentFrame.dimension().height,0] )
            .xScale(myChart.xScale0())
            .xRange( [0,currentFrame.dimension().width] );

        myXAxis1
            .align(xAxisAlign)
            .domain(columnNames)
            .rangeRound([0,currentFrame.dimension().width])

        myXAxis2
            .align(xAxisAlign)
            .domain(seriesNames)
            .rangeRound([0,myXAxis1.bandwidth()])

        myChart
            .xScale1(myXAxis1.scale())
            .xScale2(myXAxis2.scale())
            // .yScale(myYAxis.yScale())


        //Draw the highlights before the lines and xAxis
        axisHighlight
            .selectAll(".highlights")
            .data(highlights)
            .enter()
            .append("g")
            .call(myHighlights);

        currentFrame.plot()
          .call(myXAxis0)


        currentFrame.plot()
          .selectAll(".columnHolder")
          .data(plotData)
          .enter()
          .append("g")
          .attr('class', 'columnHolder')
          .attr('id', function(d) { return d.name; })
          .call(myChart)


        //Set up legend for this frame
        myLegend
            .seriesNames(seriesNames)
            .geometry(legendType)
            .rem(myChart.rem())
            .alignment(legendAlign)
            .colourPalette((frameName));

        //Draw the Legend
        currentFrame.plot()
            .append("g")
            .attr("id","legend")
                .selectAll(".legend")
                .data(seriesNames)
                .enter()
                .append("g")
                .classed("legend",true)
            .call(myLegend)
    });
    // addSVGSavers('figure.saveable');
});

//a function that returns the columns headers from the top of the dataset, excluding specified
function getSeriesNames(columns){
    var exclude = ['date','highlight']; // adjust column headings to match your dataset
    return columns.filter(d=>(exclude.indexOf(d) == -1));
}

//a function to work out the extent of values in an array accross multiple properties...
function extentMulti(data, columns){
    const ext = data.reduce((acc, row, index)=>{
        let values = columns.map(key=> +row[key])
        let rowExtent = d3.extent(values);
        if(!acc.max){
            acc.max = rowExtent[1];
            acc.min = rowExtent[0];
        }else{
            acc.max = Math.max(acc.max, rowExtent[1]);
            acc.min = Math.min(acc.min, rowExtent[0]);
        }
        return acc;
    },{});
    return [ext.min, ext.max];
}

function getColumns(data,group) {
    let columnData=[]
    data.forEach(function(el,i){
        //console.log(el,i)
        let column=new Object();
        column.name = group
        column.date = el.date
        column.value = +el[group]
        column.highlight = el.highlight
        column.annotate = el.annotate
        if(el[group]) {
            columnData.push(column)  
        } 
    });
    return columnData
}

</script>
</html>